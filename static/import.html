<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Scan - Import Cards</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="page-wrapper">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
            ‚ò∞
        </button>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <aside class="sidebar">
            <div class="logo mb-xl">
                <h2 style="color: var(--primary); font-size: var(--font-size-2xl);">‚ö° MTG Scan</h2>
                <p class="text-muted" style="font-size: var(--font-size-sm);">Scan. Sort. Done.</p>
            </div>
            <nav>
                <ul class="nav">
                    <li class="nav-item"><a href="index.html" class="nav-link"><span
                                class="nav-icon">üìä</span>Dashboard</a></li>
                    <li class="nav-item"><a href="scanner.html" class="nav-link"><span
                                class="nav-icon">üì∑</span>Scanner</a></li>
                    <li class="nav-item"><a href="library.html" class="nav-link"><span class="nav-icon">üìö</span>Card
                            Library</a></li>
                    <li class="nav-item"><a href="sorting.html" class="nav-link"><span
                                class="nav-icon">üîÑ</span>Sorting</a></li>
                    <li class="nav-item"><a href="import.html" class="nav-link active"><span
                                class="nav-icon">‚¨áÔ∏è</span>Import Cards</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>Import Cards</h1>
                <p class="text-muted">Import card data from external APIs to build your recognition database</p>
            </div>

            <!-- Single Card Import -->
            <div class="card mb-xl">
                <div class="card-header">
                    <h3 class="card-title">Import Single Card</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-md">Search for Magic: The Gathering cards using the Scryfall database.</p>
                    <div class="form-group">
                        <label class="form-label">Card Name</label>
                        <input type="text" id="cardName" class="form-input" placeholder="Enter card name...">
                    </div>
                    <button class="btn btn-primary" onclick="importSingleCard()">Import Card</button>
                </div>
            </div>

            <!-- Bulk Import -->
            <div class="card mb-xl">
                <div class="card-header">
                    <h3 class="card-title">Bulk Import (Magic: The Gathering Sets)</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Set Code</label>
                        <input type="text" id="setCode" class="form-input" placeholder="e.g., MID, VOW, NEO..."
                            style="text-transform: uppercase;">
                        <p class="text-muted" style="font-size: var(--font-size-sm); margin-top: var(--spacing-sm);">
                            Enter the 3-letter set code (e.g., MID for Midnight Hunt, VOW for Crimson Vow)
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="bulkImport()">Import Entire Set</button>
                </div>
            </div>

            <!-- Import All Cards -->
            <div class="card mb-xl" style="border: 1px solid var(--primary);">
                <div class="card-header">
                    <h3 class="card-title">üåç Import ALL Cards</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-md">
                        Import every Magic: The Gathering card from all sets.
                        This process will take a while (approx. 20-30 minutes) but will enable offline recognition for
                        all cards.
                    </p>
                    <div class="flex gap-md">
                        <button id="btnStartFull" class="btn btn-primary" onclick="startFullImport()">Start Full
                            Import</button>
                        <button id="btnStopFull" class="btn btn-danger" onclick="stopFullImport()"
                            style="display: none;">Stop Import</button>
                    </div>
                </div>
            </div>

            <!-- Full Import Progress -->
            <div id="fullImportProgressCard" class="card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">Full Import Progress</h3>
                </div>
                <div class="card-body">
                    <div class="progress-bar mb-md">
                        <div class="progress-fill" id="fullImportProgress" style="width: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-muted mb-sm">
                        <span id="fullImportSet">Initializing...</span>
                        <span id="fullImportCount">0/0 sets</span>
                    </div>
                    <div id="fullImportStats" class="text-center text-muted" style="font-size: var(--font-size-sm);">
                        Total cards imported: 0
                    </div>
                </div>
            </div>

            <!-- Import Progress -->
            <div id="progressCard" class="card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">Import Progress</h3>
                </div>
                <div class="card-body">
                    <div class="progress-bar mb-md">
                        <div class="progress-fill" id="importProgress" style="width: 0%;"></div>
                    </div>
                    <div id="progressText" class="text-center text-muted"></div>
                    <div id="currentCard" class="text-center mt-md" style="color: var(--primary);"></div>
                </div>
            </div>

            <!-- Hash Download Progress -->
            <div id="hashProgressCard" class="card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">üñºÔ∏è Image Hash Download (Background)</h3>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-md">Downloading image hashes for card recognition. This runs in the
                        background.</p>
                    <div class="progress-bar mb-md">
                        <div class="progress-fill" id="hashProgress" style="width: 0%; background: var(--info);"></div>
                    </div>
                    <div id="hashProgressText" class="text-center text-muted"></div>
                    <div class="mt-md text-center">
                        <button class="btn btn-secondary" onclick="stopHashDownload()">Stop Download</button>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="resultsCard" class="card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">Import Results</h3>
                </div>
                <div class="card-body">
                    <div id="importResults"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="app.js"></script>
    <script>
        async function importSingleCard() {
            const name = document.getElementById('cardName').value.trim();

            if (!name) {
                showNotification('Please enter a card name', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/cards/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, tcg: 'mtg' })
                });

                const data = await response.json();

                if (response.ok) {
                    showNotification(data.message, 'success');
                    document.getElementById('cardName').value = '';
                    displaySingleResult(data.card);
                } else {
                    showNotification(data.error || 'Import failed', 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showNotification('Error importing card', 'error');
            }
        }

        async function bulkImport() {
            const setCode = document.getElementById('setCode').value.trim().toUpperCase();

            if (!setCode) {
                showNotification('Please enter a set code', 'warning');
                return;
            }

            document.getElementById('progressCard').style.display = 'block';
            document.getElementById('resultsCard').style.display = 'none';

            try {
                const response = await fetch('/api/cards/bulk-import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tcg: 'mtg', set_code: setCode })
                });

                const data = await response.json();

                if (response.ok) {
                    displayBulkResults(data);
                    showNotification('Bulk import completed!', 'success');
                } else {
                    showNotification(data.error || 'Bulk import failed', 'error');
                }
            } catch (error) {
                console.error('Bulk import error:', error);
                showNotification('Error during bulk import', 'error');
            }
        }

        function displaySingleResult(card) {
            const resultsCard = document.getElementById('resultsCard');
            const resultsContainer = document.getElementById('importResults');

            resultsCard.style.display = 'block';

            resultsContainer.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 style="color: var(--primary);">${card.name}</h4>
                                <p class="text-muted mb-0">${card.set_name} ‚Ä¢ ${card.rarity}</p>
                            </div>
                            ${card.image_url ? `
                                <img src="${card.image_url}" style="width: 80px; height: 112px; border-radius: var(--radius-sm); object-fit: cover;">
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function displayBulkResults(data) {
            const resultsCard = document.getElementById('resultsCard');
            const resultsContainer = document.getElementById('importResults');
            const progressCard = document.getElementById('progressCard');

            progressCard.style.display = 'none';
            resultsCard.style.display = 'block';

            // Show hash download card if hash download started
            if (data.hash_download_started) {
                document.getElementById('hashProgressCard').style.display = 'block';
            }

            resultsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value text-success">${data.imported}</div>
                        <div class="stat-label">Cards Imported</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value text-muted">${data.skipped}</div>
                        <div class="stat-label">Already Existed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color: var(--primary);">${data.total || (data.imported + data.skipped)}</div>
                        <div class="stat-label">Total in Set</div>
                    </div>
                </div>
                <div class="mt-lg text-center">
                    <p class="text-success" style="font-size: var(--font-size-lg);">
                        ‚úì ${data.message}
                    </p>
                </div>
            `;
        }

        async function stopHashDownload() {
            try {
                await fetch('/api/hash/stop', { method: 'POST' });
                document.getElementById('hashProgressCard').style.display = 'none';
                showNotification('Hash download stopped', 'info');
            } catch (error) {
                console.error('Error stopping hash download:', error);
            }
        }

        // Listen for import progress updates
        if (window.socket) {
            window.socket.on('import_progress', (data) => {
                const progress = document.getElementById('importProgress');
                const progressText = document.getElementById('progressText');
                const currentCard = document.getElementById('currentCard');

                // Calculate percentage if total is available
                const processed = data.imported + data.skipped;
                if (data.total && data.total > 0) {
                    const percent = Math.round((processed / data.total) * 100);
                    progress.style.width = `${percent}%`;
                    progressText.textContent = `${processed}/${data.total} (${percent}%) - Imported: ${data.imported} | Skipped: ${data.skipped}`;
                } else {
                    progressText.textContent = `Imported: ${data.imported} | Skipped: ${data.skipped}`;
                }
                currentCard.textContent = `Current: ${data.current_card}`;
            });

            // Hash download progress
            window.socket.on('hash_download_started', (data) => {
                document.getElementById('hashProgressCard').style.display = 'block';
                document.getElementById('hashProgressText').textContent = `Starting download for ${data.total} cards...`;
            });

            window.socket.on('hash_download_progress', (data) => {
                const progress = document.getElementById('hashProgress');
                const progressText = document.getElementById('hashProgressText');

                progress.style.width = `${data.percent}%`;
                progressText.textContent = `${data.processed}/${data.total} (${data.percent}%) - Current: ${data.current_card}`;
            });

            window.socket.on('hash_download_complete', (data) => {
                const progressText = document.getElementById('hashProgressText');
                progressText.textContent = `‚úì Complete! ${data.processed}/${data.total} hashes downloaded.`;
                document.getElementById('hashProgress').style.width = '100%';
                document.getElementById('hashProgress').style.background = 'var(--success)';
                showNotification(`Hash download complete: ${data.processed} images processed`, 'success');
            });

            window.socket.on('hash_download_error', (data) => {
                showNotification(`Hash download error: ${data.error}`, 'error');
            });

            // Full Import Socket Listeners
            window.socket.on('full_import_progress', (data) => {
                updateFullImportUI(true);

                const percent = data.total_sets > 0 ? (data.processed_sets / data.total_sets) * 100 : 0;
                document.getElementById('fullImportProgress').style.width = `${percent}%`;
                document.getElementById('fullImportSet').textContent = `Importing: ${data.current_set}`;
                document.getElementById('fullImportCount').textContent = `${data.processed_sets}/${data.total_sets} sets`;
                document.getElementById('fullImportStats').textContent = `Total cards imported: ${data.total_cards}`;
            });

            window.socket.on('full_import_complete', (data) => {
                updateFullImportUI(false);
                showNotification('Full import completed successfully!', 'success');
                document.getElementById('fullImportSet').textContent = 'Completed!';
                document.getElementById('fullImportProgress').style.width = '100%';
                document.getElementById('fullImportProgress').style.backgroundColor = 'var(--success)';
            });

            window.socket.on('full_import_error', (data) => {
                updateFullImportUI(false);
                showNotification(`Import error: ${data.error}`, 'error');
                document.getElementById('fullImportProgress').style.backgroundColor = 'var(--error)';
            });
        }

        // Enter key support
        document.getElementById('cardName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') importSingleCard();
        });

        document.getElementById('setCode').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') bulkImport();
        });

        // Full Import Logic
        async function startFullImport() {
            if (!confirm('This will import ALL Magic cards. It may take 20-30 minutes. Continue?')) return;

            try {
                const response = await fetch('/api/cards/import-all', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    showNotification('Full import started', 'success');
                    updateFullImportUI(true);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                console.error(error);
                showNotification('Error starting import', 'error');
            }
        }

        async function stopFullImport() {
            if (!confirm('Stop the import process?')) return;

            try {
                await fetch('/api/cards/import-all/stop', { method: 'POST' });
                showNotification('Stopping import...', 'info');
            } catch (error) {
                console.error(error);
            }
        }

        function updateFullImportUI(running) {
            const btnStart = document.getElementById('btnStartFull');
            const btnStop = document.getElementById('btnStopFull');
            const progressCard = document.getElementById('fullImportProgressCard');

            if (running) {
                btnStart.style.display = 'none';
                btnStop.style.display = 'inline-block';
                progressCard.style.display = 'block';
            } else {
                btnStart.style.display = 'inline-block';
                btnStop.style.display = 'none';
            }
        }

        // Check status on load
        fetch('/api/cards/import-all/status')
            .then(res => res.json())
            .then(data => {
                if (data.running) {
                    updateFullImportUI(true);
                }
            })
            .catch(err => console.log('Status check failed', err));
        
        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }
        
        // Close sidebar when clicking a nav link on mobile
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });
    </script>
</body>

</html>