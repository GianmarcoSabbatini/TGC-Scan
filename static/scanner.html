<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Scan - Card Scanner</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Removed :root { --scanner-bg: #0a0a0a; } as we use var(--background) */
        .scanner-page {
            min-height: 100vh;
            background: var(--background);
        }

        .mode-switcher {
            display: flex;
            background: var(--surface-elevated);
            border-radius: var(--radius-lg);
            padding: 4px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .mode-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 208, 132, 0.3);
        }

        .mode-btn:hover:not(.active) {
            background: var(--surface);
            color: var(--text-primary);
        }

        .search-section {
            margin-bottom: 24px;
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 16px 20px;
            font-size: 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            background: var(--surface-elevated);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 208, 132, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-btn {
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
        }

        .search-results {
            display: none;
        }

        .search-results.visible {
            display: block;
        }

        .search-result-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .search-result-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .search-result-item .card-img {
            width: 80px;
            height: 112px;
            border-radius: var(--radius-md);
            object-fit: cover;
            flex-shrink: 0;
            background: var(--surface-elevated);
        }

        .search-result-item .card-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-item .card-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .search-result-item .card-set {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .search-result-item .card-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .search-result-item .badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .badge-rarity {
            background: var(--surface-elevated);
            color: var(--text-secondary);
        }

        .badge-rarity.mythic {
            background: linear-gradient(135deg, #ff6b35, #f7931a);
            color: white;
        }

        .badge-rarity.rare {
            background: linear-gradient(135deg, #c9a227, #f0d060);
            color: #1a1a1a;
        }

        .badge-rarity.uncommon {
            background: linear-gradient(135deg, #8b9dc3, #b8c6db);
            color: #1a1a1a;
        }

        .badge-price {
            background: var(--success);
            color: white;
        }

        .search-result-item .add-btn {
            align-self: center;
            flex-shrink: 0;
        }

        .camera-section {
            margin-bottom: 24px;
        }

        .camera-container {
            position: relative;
            background: var(--background);
            border-radius: var(--radius-xl);
            overflow: hidden;
            aspect-ratio: 3/4;
            max-height: 500px;
            border: 1px solid var(--border);
        }

        .camera-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .card-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 65%;
            aspect-ratio: 63/88;
            border: 3px solid rgba(0, 208, 132, 0.8);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .card-frame::before {
            content: "Card Name";
            position: absolute;
            top: 4%;
            left: 6%;
            right: 15%;
            height: 9%;
            font-size: 10px;
            color: rgba(255, 204, 0, 0.9);
            background: rgba(255, 204, 0, 0.15);
            border: 1px dashed rgba(255, 204, 0, 0.5);
            padding: 2px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }

        .card-frame::after {
            content: "Set Info";
            position: absolute;
            bottom: 1%;
            left: 2%;
            width: 33%;
            height: 7%;
            font-size: 9px;
            color: rgba(0, 208, 132, 0.9);
            background: rgba(0, 208, 132, 0.15);
            border: 1px dashed rgba(0, 208, 132, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-frame-corner {
            position: absolute;
            width: 24px;
            height: 24px;
            border-color: var(--primary);
            border-style: solid;
        }

        .card-frame-corner.tl {
            top: -2px;
            left: -2px;
            border-width: 4px 0 0 4px;
            border-radius: 8px 0 0 0;
        }

        .card-frame-corner.tr {
            top: -2px;
            right: -2px;
            border-width: 4px 4px 0 0;
            border-radius: 0 8px 0 0;
        }

        .card-frame-corner.bl {
            bottom: -2px;
            left: -2px;
            border-width: 0 0 4px 4px;
            border-radius: 0 0 0 8px;
        }

        .card-frame-corner.br {
            bottom: -2px;
            right: -2px;
            border-width: 0 4px 4px 0;
            border-radius: 0 0 8px 0;
        }

        .camera-top-bar {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            pointer-events: none;
            z-index: 10;
        }

        .camera-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 12px;
            border-radius: 20px;
            backdrop-filter: blur(4px);
        }
        
        .auto-scan-indicator {
            background: rgba(0, 0, 0, 0.6);
            color: rgba(255, 255, 255, 0.6);
            padding: 10px 24px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .auto-scan-indicator.active {
            background: rgba(0, 208, 132, 0.2);
            color: #00D084;
            border-color: #00D084;
        }

        .auto-scan-indicator.status-waiting {
            background: rgba(74, 158, 255, 0.2);
            color: #4A9EFF;
            border-color: #4A9EFF;
        }

        .auto-scan-indicator.status-stabilizing {
            background: rgba(255, 176, 32, 0.2);
            color: #FFB020;
            border-color: #FFB020;
        }

        .auto-scan-indicator.status-scanning {
            background: rgba(0, 208, 132, 0.8);
            color: white;
            border-color: #00D084;
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 208, 132, 0.4);
        }

        .auto-scan-indicator.status-cooldown {
            background: rgba(155, 89, 182, 0.2);
            color: #9B59B6;
            border-color: #9B59B6;
        }
        
        .card-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 65%;
            aspect-ratio: 63/88;
            border: 2px dashed rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }

        .card-frame.active-waiting {
            border-color: rgba(74, 158, 255, 0.5);
            border-style: solid;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(74, 158, 255, 0.1);
        }

        .card-frame.active-stabilizing {
            border-color: #FFB020;
            border-style: solid;
            border-width: 3px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), inset 0 0 30px rgba(255, 176, 32, 0.2);
        }

        .card-frame.active-scanning {
            border-color: #00D084;
            border-style: solid;
            border-width: 4px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 40px rgba(0, 208, 132, 0.4);
        }

        .card-frame.active-cooldown {
            border-color: #9B59B6;
            border-style: solid;
            opacity: 0.7;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--error);
        }

        .status-dot.active {
            background: var(--success);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(0, 208, 132, 0.4);
            }

            50% {
                opacity: 0.8;
                box-shadow: 0 0 0 8px rgba(0, 208, 132, 0);
            }
        }

        .camera-bottom-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            pointer-events: auto;
        }

        .cam-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cam-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .cam-btn.capture {
            width: 72px;
            height: 72px;
            background: var(--primary);
            border-color: var(--primary);
            font-size: 28px;
        }

        .cam-btn.capture:hover {
            background: var(--primary-dark);
        }

        .cam-btn.capture:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .cam-btn.auto-scan {
            background: rgba(255, 255, 255, 0.15);
            font-size: 24px;
        }
        
        .cam-btn.auto-scan.active {
            background: var(--primary);
            border-color: var(--primary);
            animation: pulse-btn 1.5s infinite;
        }
        
        @keyframes pulse-btn {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .camera-permission {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--background);
            color: white;
            text-align: center;
            padding: 24px;
        }

        .camera-permission.hidden {
            display: none;
        }

        .camera-permission .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .camera-permission h3 {
            margin-bottom: 8px;
        }

        .camera-permission p {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 24px;
        }

        .scanning-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .scanning-overlay.active {
            display: flex;
        }

        .scanning-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .upload-section {
            display: none;
        }

        .upload-section.visible {
            display: block;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-xl);
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface-elevated);
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(0, 208, 132, 0.05);
        }

        .upload-area .icon {
            font-size: 56px;
            margin-bottom: 16px;
        }

        .upload-area h3 {
            margin-bottom: 8px;
        }

        .upload-area p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .recent-scans {
            margin-top: 24px;
            padding-bottom: 80px; /* Space for mobile nav */
        }
        
        .scan-result {
            display: flex;
            gap: 16px;
            padding: 12px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            margin-bottom: 12px;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        /* Highlight the newest scan */
        .scan-result:first-child {
            border-color: var(--primary);
            background: linear-gradient(to right, rgba(0, 208, 132, 0.1), var(--surface));
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .scan-result:first-child::before {
            content: "NEW";
            position: absolute;
            top: 0;
            right: 0;
            background: var(--primary);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-bottom-left-radius: 6px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .scan-result .card-img {
            width: 70px;
            height: 98px;
            border-radius: var(--radius-md);
            object-fit: cover;
            flex-shrink: 0;
            background: var(--surface-elevated);
        }

        .scan-result .result-info {
            flex: 1;
            min-width: 0;
        }

        .scan-result .result-name {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .scan-result .result-set {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .scan-result .result-confidence {
            display: inline-block;
            padding: 4px 12px;
            background: var(--success);
            color: white;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .scan-result.error {
            border-left: 4px solid var(--error);
        }

        .scan-result.error .result-confidence {
            background: var(--error);
        }

        .options-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .option-item label {
            font-weight: 500;
            cursor: pointer;
        }

        .scan-counter {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 10px 18px;
            border-radius: var(--radius-full);
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 208, 132, 0.3);
            z-index: 100;
            display: none;
        }

        .scan-counter.visible {
            display: block;
            animation: bounceIn 0.4s ease;
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
            }

            60% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .toast-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background: var(--surface-elevated);
            color: var(--text-primary);
            padding: 14px 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 8px;
            box-shadow: var(--shadow-lg);
            animation: toastIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.info {
            border-left: 4px solid var(--info);
        }

        @keyframes toastIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
            }

            .header h1 {
                font-size: 1.4rem;
            }

            .camera-container {
                max-height: 55vh;
                border-radius: var(--radius-lg);
            }

            .search-box {
                flex-direction: column;
            }

            .search-btn {
                width: 100%;
            }

            .mobile-nav {
                display: flex !important;
            }

            body {
                padding-bottom: 80px;
            }
        }

        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 10px 0;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            z-index: 100;
        }

        .mobile-nav-links {
            display: flex;
            justify-content: space-around;
        }

        .mobile-nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 11px;
            padding: 4px 12px;
        }

        .mobile-nav-link.active {
            color: var(--primary);
        }

        .mobile-nav-link .icon {
            font-size: 22px;
        }
    </style>
</head>

<body class="scanner-page">
    <div class="page-wrapper">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
            ‚ò∞
        </button>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <aside class="sidebar">
            <div class="logo mb-xl">
                <h2 style="color: var(--primary); font-size: var(--font-size-2xl);">MTG Scan</h2>
                <p class="text-muted" style="font-size: var(--font-size-sm);">Scan. Sort. Done.</p>
            </div>
            <nav>
                <ul class="nav">
                    <li class="nav-item"><a href="index.html" class="nav-link"><span
                                class="nav-icon"></span>Dashboard</a></li>
                    <li class="nav-item"><a href="scanner.html" class="nav-link active"><span
                                class="nav-icon"></span>Scanner</a></li>
                    <li class="nav-item"><a href="library.html" class="nav-link"><span class="nav-icon"></span>Card
                            Library</a></li>
                    <li class="nav-item"><a href="sorting.html" class="nav-link"><span
                                class="nav-icon"></span>Sorting</a></li>
                    <li class="nav-item"><a href="import.html" class="nav-link"><span class="nav-icon"></span>Import
                            Cards</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1> Card Scanner</h1>
                <p class="text-muted">Scan cards or search by name to add to your collection</p>
            </div>

            <div class="toast-container" id="toastContainer"></div>
            <div class="scan-counter" id="scanCounter">0 cards</div>

            <div class="mode-switcher">
                <button class="mode-btn active" id="searchModeBtn" onclick="switchMode('search')"> Search by
                    Name</button>
                <button class="mode-btn" id="cameraModeBtn" onclick="switchMode('camera')"> Camera</button>
                <button class="mode-btn" id="uploadModeBtn" onclick="switchMode('upload')"> Upload</button>
            </div>

            <div class="options-row">
                <div class="option-item">
                    <input type="checkbox" id="isFoil">
                    <label for="isFoil"> Foil Card</label>
                </div>
            </div>

            <div class="search-section" id="searchSection">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput"
                        placeholder="Enter card name (e.g., Cloud Strife, Lightning...)" autocomplete="off">
                    <button class="btn btn-primary search-btn" id="searchBtn"> Search</button>
                </div>
                <div class="search-results" id="searchResults">
                    <div id="searchResultsContent"></div>
                </div>
            </div>

            <div class="camera-section" id="cameraSection" style="display: none;">
                <div class="camera-container" id="cameraContainer">
                    <video id="cameraPreview" autoplay playsinline muted></video>
                    <div class="camera-overlay">
                        <div class="card-frame">
                            <div class="card-frame-corner tl"></div>
                            <div class="card-frame-corner tr"></div>
                            <div class="card-frame-corner bl"></div>
                            <div class="card-frame-corner br"></div>
                        </div>
                        <div class="camera-top-bar">
                            <div class="camera-status">
                                <span class="status-dot" id="statusDot"></span>
                                <span id="statusText">Camera off</span>
                            </div>
                            <div class="auto-scan-indicator" id="autoScanStatus">Auto-Scan OFF</div>
                        </div>
                        <div class="camera-bottom-bar">
                            <button class="cam-btn" onclick="switchCamera()" title="Switch Camera">üîÑ</button>
                            <button class="cam-btn auto-scan" id="autoScanBtn" onclick="toggleAutoScan()" title="Start Auto-Scan">‚ñ∂Ô∏è</button>
                            <button class="cam-btn capture" id="captureBtn" onclick="capturePhoto()" disabled>üì∑</button>
                            <button class="cam-btn" onclick="toggleFlash()" id="flashBtn" title="Flash">‚ö°</button>
                        </div>
                        <div class="scanning-overlay" id="scanningOverlay">
                            <div class="scanning-spinner"></div>
                            <p>Analyzing card...</p>
                        </div>
                    </div>
                    <div class="camera-permission" id="cameraPermission">
                        <div class="icon"></div>
                        <h3>Camera Access Required</h3>
                        <p>Allow camera access to scan your cards</p>
                        <button class="btn btn-primary btn-lg" onclick="startCamera()">Enable Camera</button>
                    </div>
                </div>
            </div>

            <div class="upload-section" id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <div class="icon"></div>
                    <h3>Upload Card Images</h3>
                    <p>Click to select files or drag and drop here</p>
                    <input type="file" id="fileInput" accept="image/*" multiple hidden>
                </div>
            </div>

            <div class="recent-scans" id="recentScans" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recent Scans</h3>
                        <button class="btn btn-sm btn-secondary" onclick="clearResults()">Clear All</button>
                    </div>
                    <div class="card-body" id="resultsContainer"></div>
                </div>
            </div>
        </main>
    </div>

    <nav class="mobile-nav">
        <div class="mobile-nav-links">
            <a href="index.html" class="mobile-nav-link"><span class="icon"></span><span>Dashboard</span></a>
            <a href="scanner.html" class="mobile-nav-link active"><span class="icon"></span><span>Scanner</span></a>
            <a href="library.html" class="mobile-nav-link"><span class="icon"></span><span>Library</span></a>
            <a href="sorting.html" class="mobile-nav-link"><span class="icon"></span><span>Sorting</span></a>
        </div>
    </nav>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="app.js"></script>
    <script>
        let cameraStream = null;
        let currentFacingMode = 'environment';
        let flashEnabled = false;
        let isScanning = false;
        let scanResults = [];
        let scanCount = 0;
        let searchTimeout = null;
        
        // === AUTO-SCAN CONTINUOUS MODE ===
        let autoScanEnabled = false;
        let autoScanInterval = null;
        let lastScanTime = 0;
        let previousFrameData = null;
        let stableFrameCount = 0;
        let scanCooldown = 2000; // ms between scans
        let stabilityThreshold = 5; // frames of stability before scan
        let cardDetectionCanvas = null;
        let cardDetectionCtx = null;
        
        // Audio feedback
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playBeep(type = 'success') {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'success') {
                // Pleasant success beep - two ascending tones
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                oscillator.frequency.setValueAtTime(1108, audioContext.currentTime + 0.1); // C#6
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialDecayTo(0.01, audioContext.currentTime + 0.3);
            } else if (type === 'error') {
                // Error beep - lower descending tone
                oscillator.frequency.setValueAtTime(330, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(220, audioContext.currentTime + 0.15);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialDecayTo(0.01, audioContext.currentTime + 0.3);
            } else if (type === 'detecting') {
                // Soft tick when card detected
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialDecayTo(0.01, audioContext.currentTime + 0.05);
            }
            
            oscillator.type = 'sine';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        // Polyfill for exponentialDecayTo
        if (!GainNode.prototype.exponentialDecayTo) {
            GainNode.prototype.exponentialDecayTo = function(value, endTime) {
                this.gain.exponentialRampToValueAtTime(Math.max(value, 0.0001), endTime);
            };
        }
        
        function initCardDetection() {
            cardDetectionCanvas = document.createElement('canvas');
            cardDetectionCtx = cardDetectionCanvas.getContext('2d', { willReadFrequently: true });
        }
        
        function toggleAutoScan() {
            autoScanEnabled = !autoScanEnabled;
            const btn = document.getElementById('autoScanBtn');
            const statusIndicator = document.getElementById('autoScanStatus');
            
            if (autoScanEnabled) {
                btn.classList.add('active');
                btn.innerHTML = '‚è∏Ô∏è';
                btn.title = 'Stop Auto-Scan';
                statusIndicator.classList.add('active');
                statusIndicator.textContent = 'Auto-Scan ON';
                startAutoScanLoop();
                // Resume audio context if suspended (browser policy)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                showToast('üîÑ Auto-scan enabled - place cards in frame', 'success');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '‚ñ∂Ô∏è';
                btn.title = 'Start Auto-Scan';
                statusIndicator.classList.remove('active');
                statusIndicator.textContent = 'Auto-Scan OFF';
                stopAutoScanLoop();
                showToast('‚èπÔ∏è Auto-scan disabled', 'info');
            }
        }
        
        function startAutoScanLoop() {
            if (autoScanInterval) return;
            
            initCardDetection();
            autoScanInterval = setInterval(() => {
                if (!cameraStream || isScanning || !autoScanEnabled) return;
                analyzeFrame();
            }, 100); // Check 10 times per second
        }
        
        function stopAutoScanLoop() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
                autoScanInterval = null;
            }
            previousFrameData = null;
            stableFrameCount = 0;
        }
        
        function analyzeFrame() {
            if (!cameraPreview.videoWidth || !cameraPreview.videoHeight) return;
            
            // Set canvas size to a smaller analysis size for performance
            const analysisWidth = 160;
            const analysisHeight = 120;
            cardDetectionCanvas.width = analysisWidth;
            cardDetectionCanvas.height = analysisHeight;
            
            // Draw current frame
            cardDetectionCtx.drawImage(cameraPreview, 0, 0, analysisWidth, analysisHeight);
            const currentFrameData = cardDetectionCtx.getImageData(0, 0, analysisWidth, analysisHeight);
            
            // Check if card-like object is in frame (center region analysis)
            const hasCardInFrame = detectCardInFrame(currentFrameData);
            
            if (!hasCardInFrame) {
                stableFrameCount = 0;
                previousFrameData = null;
                updateAutoScanStatus('waiting');
                return;
            }
            
            // Check frame stability (card not moving)
            if (previousFrameData) {
                const frameDiff = calculateFrameDifference(previousFrameData, currentFrameData);
                
                if (frameDiff < 5) { // Frame is stable (less than 5% change)
                    stableFrameCount++;
                    updateAutoScanStatus('stabilizing', stableFrameCount);
                    
                    // Check cooldown
                    const timeSinceLastScan = Date.now() - lastScanTime;
                    if (timeSinceLastScan < scanCooldown) {
                        updateAutoScanStatus('cooldown', Math.ceil((scanCooldown - timeSinceLastScan) / 1000));
                        return;
                    }
                    
                    // If stable enough, trigger scan
                    if (stableFrameCount >= stabilityThreshold) {
                        stableFrameCount = 0;
                        triggerAutoScan();
                    }
                } else {
                    stableFrameCount = 0;
                    updateAutoScanStatus('moving');
                }
            }
            
            previousFrameData = currentFrameData;
        }
        
        function detectCardInFrame(imageData) {
            // Analyze the center region of the frame for card-like characteristics
            // Cards have distinct edges and contrast against background
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            
            // Define center region (where card should be)
            const centerX = Math.floor(width * 0.3);
            const centerY = Math.floor(height * 0.2);
            const centerW = Math.floor(width * 0.4);
            const centerH = Math.floor(height * 0.6);
            
            let edgePixels = 0;
            let totalPixels = 0;
            let avgBrightness = 0;
            
            // Simple edge detection in center region
            for (let y = centerY; y < centerY + centerH - 1; y++) {
                for (let x = centerX; x < centerX + centerW - 1; x++) {
                    const idx = (y * width + x) * 4;
                    const idxRight = (y * width + x + 1) * 4;
                    const idxDown = ((y + 1) * width + x) * 4;
                    
                    const gray = (data[idx] + data[idx + 1] + data[idx + 2]) / 3;
                    const grayRight = (data[idxRight] + data[idxRight + 1] + data[idxRight + 2]) / 3;
                    const grayDown = (data[idxDown] + data[idxDown + 1] + data[idxDown + 2]) / 3;
                    
                    avgBrightness += gray;
                    totalPixels++;
                    
                    // Check for edge (significant brightness change)
                    if (Math.abs(gray - grayRight) > 30 || Math.abs(gray - grayDown) > 30) {
                        edgePixels++;
                    }
                }
            }
            
            avgBrightness /= totalPixels;
            const edgeRatio = edgePixels / totalPixels;
            
            // Card should have some edges (text, art) but not too many (noise)
            // and reasonable brightness (not too dark)
            const hasCard = edgeRatio > 0.02 && edgeRatio < 0.4 && avgBrightness > 40;
            
            return hasCard;
        }
        
        function calculateFrameDifference(frame1, frame2) {
            const data1 = frame1.data;
            const data2 = frame2.data;
            let diff = 0;
            
            // Sample every 4th pixel for performance
            for (let i = 0; i < data1.length; i += 16) {
                diff += Math.abs(data1[i] - data2[i]); // Red channel only
            }
            
            return (diff / (data1.length / 16)) / 255 * 100; // Return as percentage
        }
        
        function updateAutoScanStatus(status, value) {
            const statusEl = document.getElementById('autoScanStatus');
            const cardFrame = document.querySelector('.card-frame');
            
            // Reset classes
            statusEl.className = 'auto-scan-indicator active';
            cardFrame.className = 'card-frame';
            
            switch(status) {
                case 'waiting':
                    statusEl.innerHTML = '<span class="icon">üëÅÔ∏è</span> Waiting for card...';
                    statusEl.classList.add('status-waiting');
                    cardFrame.classList.add('active-waiting');
                    break;
                case 'moving':
                    statusEl.innerHTML = '<span class="icon">‚úã</span> Hold steady...';
                    statusEl.classList.add('status-waiting'); // Use waiting style for moving
                    cardFrame.classList.add('active-waiting');
                    break;
                case 'stabilizing':
                    statusEl.innerHTML = `<span class="icon">üéØ</span> Stabilizing... ${value}/${stabilityThreshold}`;
                    statusEl.classList.add('status-stabilizing');
                    cardFrame.classList.add('active-stabilizing');
                    break;
                case 'cooldown':
                    statusEl.innerHTML = `<span class="icon">‚è≥</span> Next in ${value}s`;
                    statusEl.classList.add('status-cooldown');
                    cardFrame.classList.add('active-cooldown');
                    break;
                case 'scanning':
                    statusEl.innerHTML = '<span class="icon">üì∏</span> SCANNING!';
                    statusEl.classList.add('status-scanning');
                    cardFrame.classList.add('active-scanning');
                    break;
            }
        }
        
        async function triggerAutoScan() {
            if (isScanning) return;
            
            updateAutoScanStatus('scanning');
            playBeep('detecting');
            
            // Capture and scan
            isScanning = true;
            scanningOverlay.classList.add('active');
            
            const canvas = document.createElement('canvas');
            canvas.width = cameraPreview.videoWidth;
            canvas.height = cameraPreview.videoHeight;
            canvas.getContext('2d').drawImage(cameraPreview, 0, 0);
            
            canvas.toBlob(async (blob) => {
                const result = await scanCardImageAuto(blob);
                
                isScanning = false;
                scanningOverlay.classList.remove('active');
                lastScanTime = Date.now();
                
                if (result && result.success) {
                    playBeep('success');
                    // Flash green border
                    const cardFrame = document.querySelector('.card-frame');
                    cardFrame.style.borderColor = '#00ff00';
                    cardFrame.style.boxShadow = '0 0 30px rgba(0, 255, 0, 0.5), 0 0 0 9999px rgba(0, 0, 0, 0.5)';
                    setTimeout(() => {
                        cardFrame.style.borderColor = 'rgba(0, 208, 132, 0.8)';
                        cardFrame.style.boxShadow = '0 0 0 9999px rgba(0, 0, 0, 0.5)';
                    }, 500);
                } else {
                    playBeep('error');
                }
            }, 'image/jpeg', 0.92);
        }
        
        async function scanCardImageAuto(blob) {
            const isFoil = document.getElementById('isFoil').checked;
            const formData = new FormData();
            formData.append('file', blob, 'capture.jpg');
            formData.append('tcg', 'mtg');
            formData.append('is_foil', isFoil);
            
            try {
                const response = await fetch('/api/scan/upload', { method: 'POST', body: formData });
                const result = await response.json();
                
                if (result.success) {
                    scanCount++;
                    updateScanCounter();
                    showToast('‚úÖ ' + result.card.name + ' (' + Math.round(result.confidence * 100) + '%)', 'success');
                    addToRecentScans(result);
                    return result;
                } else {
                    // In auto mode, don't show error for every failed scan
                    // Just log it and continue
                    console.log('Auto-scan: Card not recognized', result);
                    return result;
                }
            } catch (error) {
                console.error('Auto-scan error:', error);
                return null;
            }
        }

        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const searchResultsContent = document.getElementById('searchResultsContent');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraPermission = document.getElementById('cameraPermission');
        const captureBtn = document.getElementById('captureBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const scanningOverlay = document.getElementById('scanningOverlay');
        const toastContainer = document.getElementById('toastContainer');
        const recentScans = document.getElementById('recentScans');
        const resultsContainer = document.getElementById('resultsContainer');
        const scanCounter = document.getElementById('scanCounter');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode + 'ModeBtn').classList.add('active');
            document.getElementById('searchSection').style.display = mode === 'search' ? 'block' : 'none';
            document.getElementById('cameraSection').style.display = mode === 'camera' ? 'block' : 'none';
            document.getElementById('uploadSection').style.display = mode === 'upload' ? 'block' : 'none';
            if (mode === 'camera') { if (!cameraStream) startCamera(); } else { stopCamera(); }
        }

        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();
            if (query.length >= 2) { searchTimeout = setTimeout(() => performSearch(query), 400); }
            else { searchResults.classList.remove('visible'); }
        });

        searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(searchInput.value.trim()); });
        searchBtn.addEventListener('click', () => performSearch(searchInput.value.trim()));

        async function performSearch(query) {
            if (!query || query.length < 2) return;
            searchResultsContent.innerHTML = '<div style="text-align: center; padding: 32px;"><div class="scanning-spinner" style="margin: 0 auto 16px;"></div><p class="text-muted">Searching...</p></div>';
            searchResults.classList.add('visible');
            try {
                const response = await fetch('/api/cards/search/api?q=' + encodeURIComponent(query) + '&tcg=mtg');
                const data = await response.json();
                if (data.cards && data.cards.length > 0) { displaySearchResults(data.cards); }
                else { searchResultsContent.innerHTML = '<div style="text-align: center; padding: 32px; background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border);"><div style="font-size: 48px; margin-bottom: 16px;"></div><p style="font-weight: 600;">No cards found for "' + query + '"</p></div>'; }
            } catch (error) { searchResultsContent.innerHTML = '<div style="text-align: center; padding: 32px; color: var(--error);"><p>Error: ' + error.message + '</p></div>'; }
        }

        function displaySearchResults(cards) {
            searchResultsContent.innerHTML = cards.map(card => {
                const rarity = (card.rarity || 'common').toLowerCase();
                let rarityClass = '';
                if (rarity.includes('mythic')) rarityClass = 'mythic';
                else if (rarity.includes('rare')) rarityClass = 'rare';
                else if (rarity.includes('uncommon')) rarityClass = 'uncommon';
                return '<div class="search-result-item" onclick="addCardToCollection(\'' + escapeHtml(card.name).replace(/'/g, "\\'") + '\')">' +
                    (card.image_url ? '<img src="' + card.image_url + '" alt="' + escapeHtml(card.name) + '" class="card-img">' : '<div class="card-img" style="display: flex; align-items: center; justify-content: center; font-size: 32px;"></div>') +
                    '<div class="card-info"><div class="card-name">' + escapeHtml(card.name) + '</div><div class="card-set">' + escapeHtml(card.set_name || 'Unknown Set') + '</div><div class="card-meta"><span class="badge badge-rarity ' + rarityClass + '">' + (card.rarity || 'Common') + '</span>' +
                    (card.price_eur ? '<span class="badge badge-price">ÔøΩ' + card.price_eur + '</span>' : (card.price_usd ? '<span class="badge badge-price">$' + card.price_usd + '</span>' : '')) +
                    '</div></div><button class="btn btn-primary btn-sm add-btn"> Add</button></div>';
            }).join('');
        }

        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        async function addCardToCollection(cardName) {
            const isFoil = document.getElementById('isFoil').checked;
            showToast('Adding ' + cardName + '...', 'info');
            try {
                const response = await fetch('/api/cards/import', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: cardName, tcg: 'mtg', is_foil: isFoil }) });
                const data = await response.json();
                if (response.ok) { scanCount++; updateScanCounter(); showToast('Added "' + cardName + '" to collection!', 'success'); searchInput.value = ''; searchResults.classList.remove('visible'); addToRecentScans({ success: true, card: data.card, confidence: 1.0 }); }
                else { showToast(data.error || 'Failed to add card', 'error'); }
            } catch (error) { showToast('Error: ' + error.message, 'error'); }
        }

        async function startCamera() {
            cameraPermission.classList.add('hidden');

            // Check if camera API is available (requires HTTPS on mobile)
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                cameraPermission.classList.remove('hidden');
                if (!isSecure) {
                    cameraPermission.innerHTML = '<div class="icon">üîí</div><h3>HTTPS Required</h3><p>Camera access requires a secure connection (HTTPS).<br><br>On mobile, use <strong>Search by Name</strong> or <strong>Upload</strong> instead.</p><button class="btn btn-primary btn-lg" onclick="switchMode(\'search\')">üîç Use Search</button>';
                } else {
                    cameraPermission.innerHTML = '<div class="icon">üì∑</div><h3>Camera Not Available</h3><p>Your browser does not support camera access.</p><button class="btn btn-primary btn-lg" onclick="switchMode(\'upload\')">üì§ Use Upload</button>';
                }
                return;
            }

            try {
                const constraints = { video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } }, audio: false };
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraPreview.srcObject = cameraStream;
                cameraPreview.onloadedmetadata = () => { statusDot.classList.add('active'); statusText.textContent = 'Camera active'; captureBtn.disabled = false; };
            } catch (err) {
                console.error('Camera error:', err);
                cameraPermission.classList.remove('hidden');
                let errorMsg = err.message || 'Could not access camera';
                if (err.name === 'NotAllowedError') {
                    errorMsg = 'Camera access was denied. Please allow camera permissions in your browser settings.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg = 'No camera found on this device.';
                }
                cameraPermission.innerHTML = '<div class="icon">‚ö†Ô∏è</div><h3>Camera Error</h3><p>' + errorMsg + '</p><button class="btn btn-secondary btn-lg" onclick="switchMode(\'search\')" style="margin-right: 8px;">üîç Search</button><button class="btn btn-primary btn-lg" onclick="startCamera()">Try Again</button>';
            }
        }

        function stopCamera() { 
            if (autoScanEnabled) {
                toggleAutoScan(); // Stop auto-scan when camera stops
            }
            if (cameraStream) { 
                cameraStream.getTracks().forEach(track => track.stop()); 
                cameraStream = null; 
            } 
            cameraPreview.srcObject = null; 
            statusDot.classList.remove('active'); 
            statusText.textContent = 'Camera off'; 
            captureBtn.disabled = true; 
        }

        async function switchCamera() { currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment'; stopCamera(); await startCamera(); showToast('Switched to ' + (currentFacingMode === 'environment' ? 'back' : 'front') + ' camera', 'success'); }

        function toggleFlash() { if (!cameraStream) return; const track = cameraStream.getVideoTracks()[0]; const capabilities = track.getCapabilities(); if (capabilities.torch) { flashEnabled = !flashEnabled; track.applyConstraints({ advanced: [{ torch: flashEnabled }] }); document.getElementById('flashBtn').style.background = flashEnabled ? 'var(--warning)' : ''; showToast('Flash ' + (flashEnabled ? 'on' : 'off'), 'success'); } else { showToast('Flash not available', 'error'); } }

        async function capturePhoto() { if (!cameraStream || isScanning) return; isScanning = true; scanningOverlay.classList.add('active'); captureBtn.disabled = true; const canvas = document.createElement('canvas'); canvas.width = cameraPreview.videoWidth; canvas.height = cameraPreview.videoHeight; canvas.getContext('2d').drawImage(cameraPreview, 0, 0); canvas.toBlob(async (blob) => { await scanCardImage(blob); isScanning = false; scanningOverlay.classList.remove('active'); captureBtn.disabled = false; }, 'image/jpeg', 0.92); }

        async function scanCardImage(blob) {
            const isFoil = document.getElementById('isFoil').checked;
            const formData = new FormData(); formData.append('file', blob, 'capture.jpg'); formData.append('tcg', 'mtg'); formData.append('is_foil', isFoil);
            try {
                const response = await fetch('/api/scan/upload', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    scanCount++;
                    updateScanCounter();
                    showToast('‚úÖ ' + result.card.name + ' recognized!', 'success');
                    addToRecentScans(result);
                } else {
                    // Show helpful error with suggestion to search manually
                    const errorMsg = result.extracted_name
                        ? 'Partial text detected: "' + result.extracted_name + '". Try searching manually.'
                        : 'Card not recognized. Try better lighting or use Search by Name.';
                    showToast('‚ö†Ô∏è ' + errorMsg, 'error');
                    addToRecentScans({ success: false, message: errorMsg });
                    // Auto-switch to search mode and pre-fill if we got partial text
                    if (result.extracted_name && result.extracted_name.length >= 3) {
                        switchMode('search');
                        searchInput.value = result.extracted_name;
                        searchInput.focus();
                        performSearch(result.extracted_name);
                    }
                }
            } catch (error) { showToast('‚ùå Scan failed: ' + error.message, 'error'); }
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleUploadedFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => { handleUploadedFiles(e.target.files); });

        async function handleUploadedFiles(files) { for (const file of files) { if (!file.type.startsWith('image/')) continue; showToast('Scanning ' + file.name + '...', 'info'); await scanCardImage(file); } fileInput.value = ''; }

        function addToRecentScans(result) { 
            scanResults.unshift(result); 
            if (scanResults.length > 20) scanResults.pop(); // Keep more history
            displayRecentScans(); 
            recentScans.style.display = 'block'; 
            
            // Scroll to recent scans if not visible
            if (scanCount === 1) {
                recentScans.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function displayRecentScans() {
            resultsContainer.innerHTML = scanResults.map(result => {
                if (result.success) { return '<div class="scan-result">' + (result.card.image_url ? '<img src="' + result.card.image_url + '" class="card-img">' : '<div class="card-img" style="display: flex; align-items: center; justify-content: center;"></div>') + '<div class="result-info"><div class="result-name">' + result.card.name + '</div><div class="result-set">' + (result.card.set_name || 'Unknown Set') + '</div><span class="result-confidence">' + Math.round(result.confidence * 100) + '% match</span></div></div>'; }
                else { return '<div class="scan-result error"><div class="card-img" style="display: flex; align-items: center; justify-content: center;"></div><div class="result-info"><div class="result-name">Recognition Failed</div><div class="result-set">' + (result.message || 'Try again with better lighting') + '</div><span class="result-confidence">Failed</span></div></div>'; }
            }).join('');
        }

        function clearResults() { scanResults = []; resultsContainer.innerHTML = ''; recentScans.style.display = 'none'; }
        function updateScanCounter() { scanCounter.textContent = scanCount + ' card' + (scanCount !== 1 ? 's' : ''); scanCounter.classList.add('visible'); }
        function showToast(message, type) { const toast = document.createElement('div'); toast.className = 'toast ' + type; toast.textContent = message; toastContainer.appendChild(toast); setTimeout(() => { toast.style.animation = 'toastIn 0.3s ease reverse'; setTimeout(() => toast.remove(), 300); }, 3000); }

        window.addEventListener('beforeunload', stopCamera);
        document.addEventListener('visibilitychange', () => { if (document.hidden && cameraStream) stopCamera(); });
        
        // Mobile sidebar toggle
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }
        
        // Close sidebar when clicking a nav link on mobile
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });
    </script>
</body>

</html>